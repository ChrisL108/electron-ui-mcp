# Code Review: electron-ui-mcp

**Reviewer:** GPT-5 (Codex CLI)
**Date:** 2025-12-29
**Commit:** 06e5b6704614e446e93f0a737f1593c6ae52c4f8

## Executive Summary
The project is well-structured and aligns with the intended Playwright-style MCP surface area. The lazy initialization pattern in `ElectronContext` is clear, the tool registry is clean, and the documentation gives a good operational overview for users integrating into Claude/Codex/Gemini. Unit tests cover config/refs/errors at a basic level.

The biggest gaps are around multi-window correctness and snapshot/ref lifecycle. Snapshot refs and annotation bounding boxes are globally shared across windows and don’t carry snapshot identity into tool calls, which can lead to cross-window mis-targeting and undetected stale refs. There are also reliability issues in `ElectronContext` around duplicate event handlers and dialog handling that can cause memory leaks or inconsistent runtime behavior.

Addressing these concerns will materially improve correctness and predictability, especially for multi-window apps and repeated automation sessions. The rest of the feedback is mostly about edge cases, annotations, and test coverage.

## Architecture & Design
- Global snapshot/ref state is not scoped to a window or page, so a snapshot taken in one window can influence refs and annotated screenshots in another, leading to mis-targeting and misleading overlays. This is most evident in the global `currentBoundingBoxes` and `refManager` usage. (`src/electron/snapshot.ts:35-51`, `src/electron/snapshot.ts:403-513`, `src/utils/refs.ts:25-123`)
- `ElectronContext` attaches page handlers every time `getPage` or `selectWindow` is called, without de-duping. This can multiply dialog/console/network handlers and produce duplicated events or memory leaks over long sessions. (`src/electron/context.ts:195-246`, `src/electron/context.ts:265-352`)
- Stale ref detection is implemented in `RefManager.getElement`, but no tool accepts a snapshot id to use it, so the user can only get `RefNotFoundError`, not `StaleRefError`. This weakens “stale ref” guidance behavior. (`src/utils/refs.ts:84-103`, `src/tools/snapshot.ts:23-57`)
- `browser_tabs` identifies `activeIndex` as the first non-closed window instead of the current selected window, which can be misleading in multi-window apps. (`src/tools/windows.ts:44-50`)

## Code Quality
- `browser_wait_for` uses `page.waitForSelector(
  \`text=${text}\`)` without escaping, which can break for quotes or regex-like characters in text. Consider using `page.getByText(text).waitFor()` or escaping text to avoid selector errors. (`src/tools/waiting.ts:63-66`)
- `browser_network_requests` builds a `RegExp` from user input without handling invalid patterns, which will throw and fail the tool unexpectedly. (`src/tools/windows.ts:206-216`)
- `browser_navigate_back` doesn’t check the return of `page.goBack()`; Playwright returns `null` when no history exists, so the tool may report success with unchanged URL. (`src/tools/navigation.ts:78-87`)
- The custom accessible name implementation is incomplete vs. Playwright’s accessibility name computation (e.g., multi-id `aria-labelledby`, name computation rules). This can yield refs that `getByRole` doesn’t match. (`src/electron/snapshot.ts:59-102`, `src/utils/refs.ts:110-115`)

## MCP Compliance
- Tool naming matches the Playwright MCP surface; schemas are largely aligned. However, some tool annotation hints appear inconsistent with side effects (e.g., `browser_navigate` marked `idempotentHint: true`). Consider aligning idempotent/destructive hints with actual effects. (`src/tools/navigation.ts:28-31`)
- `browser_snapshot` returns only `content` text instead of a structured tree; if the Playwright MCP schema expects a richer snapshot payload, LLM compatibility may be reduced. (Verify against the target MCP schema.) (`src/tools/snapshot.ts:31-57`)

## Security Concerns
- **High:** `electron_evaluate_main` executes arbitrary JS in the Electron main process. This is inherently powerful and should be explicitly documented as such and optionally gated via config (disable/allow-list) for safer deployments. (`src/tools/evaluation.ts:44-83`)
- **Medium:** The launch environment passes all `process.env` values into the Electron app, which can unintentionally leak secrets to the app or its renderer if the app logs or exposes env. Consider allowing an allowlist/denylist or an opt-in passthrough mode. (`src/electron/context.ts:107-115`)
- **Low:** `browser_file_upload` accepts arbitrary file paths without validation. This is expected for automation but worth noting in docs as it can read local files. (`src/tools/interaction.ts:356-388`)

## Reliability & Edge Cases
- Event handlers on pages are not de-duplicated. Re-selecting a window or re-resolving the current page can cause multiple listeners to stack, producing duplicate console/network/dialog entries and potentially leaking memory. (`src/electron/context.ts:195-246`, `src/electron/context.ts:265-352`)
- Dialog handling is split between `page.on('dialog')` (queue) and `page.waitForEvent('dialog')` (tool). If a dialog appears before `browser_handle_dialog` is called, the tool returns a “pending dialogs” response but does not attempt to handle it, leaving the dialog open. Consider using the queued dialog object to accept/dismiss it. (`src/electron/context.ts:195-205`, `src/tools/waiting.ts:134-175`)
- Snapshot ref invalidation does not clearly correlate with annotated screenshots. `browser_take_screenshot` can take a snapshot implicitly (when annotate=true and no snapshot exists), invalidating previous refs with no explicit signal to the caller. This can surprise users. (`src/electron/snapshot.ts:491-499`, `src/tools/snapshot.ts:33-57`)
- `browser_tabs` can “select” a closed window without checking `isClosed`, which may cause the selection to silently fall back to another window in `getPage()`. (`src/electron/context.ts:331-352`, `src/tools/windows.ts:52-61`)

## Testing Coverage
- Missing tests for `ElectronContext` lifecycle behavior (ensureReady, close/reset, re-launch after close, multi-window selection).
- No tests for snapshot generation, ref mapping fidelity, or annotated screenshots (including cross-window or scrolling cases).
- No integration tests for tool schemas or dialog handling; a minimal fixture Electron app is referenced in design docs but not implemented.
- Add E2E smoke tests using a minimal Electron fixture app that opens multiple windows, renders dialogs, and includes labeled controls with `data-testid` to validate ref resolution deterministically.

## Documentation
- README is clear and practical. Consider adding a short section warning that `electron_evaluate_main` executes arbitrary code and should only be used in trusted environments. (`README.md:109-160`, `src/tools/evaluation.ts:44-83`)
- Document the implicit snapshot invalidation when `browser_take_screenshot` with `annotate: true` triggers `captureSnapshot`. (`README.md:146-226`, `src/electron/snapshot.ts:491-499`)
- Add a note about environment variable passthrough and possible secret exposure. (`src/electron/context.ts:107-115`)

## Performance
- Snapshot collection traverses the DOM, computes styles, and bounding boxes for all candidate nodes. For large DOMs this can be heavy; consider optional “fast” mode that skips bounds or reduces traversal depth. (`src/electron/snapshot.ts:58-305`)
- Repeatedly attaching page handlers increases per-event processing cost; deduping handlers or tracking attached pages would reduce overhead. (`src/electron/context.ts:195-246`)

## Recommended Improvements

### High Priority
- Scope snapshot refs and bounding boxes to a page/window (or include page identity in snapshot state) to avoid cross-window mis-targeting. (`src/electron/snapshot.ts:35-51`, `src/utils/refs.ts:25-123`)
- Prevent duplicate event handler attachment in `ElectronContext` when switching windows or re-resolving the current page. (`src/electron/context.ts:195-246`, `src/electron/context.ts:265-352`)
- Expose and use `snapshotId` in tool inputs so stale refs can be detected reliably (or enforce ref invalidation messaging in tool responses). (`src/utils/refs.ts:84-103`, `src/tools/snapshot.ts:31-57`)

### Medium Priority
- Fix `browser_tabs` active window reporting to reflect the selected/current page. (`src/tools/windows.ts:44-61`)
- Handle dialog cases where the dialog already appeared by consuming queued dialogs in `browser_handle_dialog`. (`src/tools/waiting.ts:134-175`, `src/electron/context.ts:195-205`)
- Harden `browser_wait_for` text matching by avoiding raw selector interpolation. (`src/tools/waiting.ts:63-66`)

### Low Priority / Nice-to-Have
- Validate regex inputs in `browser_network_requests` and return a friendly error on invalid patterns. (`src/tools/windows.ts:206-216`)
- Update README to mention the security implications of `electron_evaluate_main` and env passthrough. (`README.md:109-160`, `src/electron/context.ts:107-115`)
- Add tests for `browser_navigate_back` when no history is available and reflect non-navigation in response. (`src/tools/navigation.ts:78-87`)

## Conclusion
The project delivers a solid MVP MCP server with a clear architecture and minimal APIs. However, multi-window behavior, snapshot/ref scoping, and handler lifecycle management introduce correctness and reliability risks that will surface quickly in real-world automation. Addressing these high-priority items would make the server more predictable and robust for LLM-driven UI automation.
